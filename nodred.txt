"""
cp_publisher.py
----------------
Publisher contínuo dos 7 compressores (cp01..cp07) no MQTT.

Instalação:
  pip install paho-mqtt

Execução:
  python cp_publisher.py

Tópicos publicados (QoS 1, retain=True):
  factory/vars/clp_1500_cp/cpXX_pressao
  factory/vars/clp_1500_cp/cpXX_sp
  factory/vars/clp_1500_cp/cpXX_adm
  factory/vars/clp_1500_cp/cpXX_by

Comando suportado:
  factory/cmd/snapshot  (payload qualquer) -> republica todos imediatamente

Status:
  factory/status   "online"/"offline" (retain=True)
"""

import time
import random
import signal
import sys
from typing import Tuple
import paho.mqtt.client as mqtt

# ===================== CONFIG ===================== #
BROKER = "172.29.138.138"
PORT   = 1883
CLIENT_ID = "py-clp-publisher-cps"  # deixe único
KEEPALIVE = 60

CP_IDS = ["cp01", "cp02", "cp03", "cp04", "cp05", "cp06", "cp07"]

# Periodicidade da publicação contínua
PUBLISH_INTERVAL_S = 1.0           # publique a cada 1s (ajuste se quiser)
ONLY_IF_CHANGED    = False          # True: publica só se mudou (a cada 10s força full)

SNAPSHOT_TOPIC = "factory/cmd/snapshot"
STATUS_TOPIC   = "factory/status"   # online/offline (retain)

# Força republish de todos pelo menos a cada X segundos (proteção)
FULL_REPUBLISH_EVERY_S = 10
# ================================================== #


def read_values(cp: str) -> Tuple[float, float, int, int]:
    """
    TROQUE ESTA FUNÇÃO pela leitura real do seu CLP/PLC.
    Deve retornar: (pressao_bar, setpoint_bar, adm_pct, by_pct)

    Abaixo: gerador de valores de demonstração.
    """
    pressao = round(8.2 + random.uniform(-0.4, 0.4), 2)
    setpoint = 8.50
    adm = random.choice([0, 100])
    by  = random.choice([0, 100])
    return pressao, setpoint, adm, by


def topic_base(cp: str) -> str:
    return f"factory/vars/clp_1500_cp/{cp}"


class CPPublisher:
    def __init__(self):
        self.cli = mqtt.Client(
            client_id=CLIENT_ID,
            protocol=mqtt.MQTTv311,      # 3.1.1
            clean_session=True           # sessão limpa (evita conflitos)
        )
        # Last will (se cair desconecta “offline”)
        self.cli.will_set(STATUS_TOPIC, "offline", qos=1, retain=True)

        self.cli.on_connect = self.on_connect
        self.cli.on_message = self.on_message
        self.cli.on_disconnect = self.on_disconnect

        self._running = True
        self._last_values = {}   # último valor publicado por cp -> dict
        self._last_full = 0.0

    # ---------- MQTT callbacks ---------- #
    def on_connect(self, cli, userdata, flags, rc, properties=None):
        print(f"[MQTT] conectado rc={rc}")
        # status online
        cli.publish(STATUS_TOPIC, "online", qos=1, retain=True)
        # assina snapshot
        cli.subscribe(SNAPSHOT_TOPIC, qos=1)
        # republica tudo ao reconectar
        self.publish_all(retain=True, reason="on_connect")

    def on_disconnect(self, cli, userdata, rc, properties=None):
        print(f"[MQTT] desconectado rc={rc}")

    def on_message(self, cli, userdata, msg):
        if msg.topic == SNAPSHOT_TOPIC:
            print("[CMD] snapshot → republicando todos")
            self.publish_all(retain=True, reason="snapshot")

    # ---------- publicação ---------- #
    def publish_cp(self, cp: str, pressao: float, sp: float, adm: int, by: int,
                   retain: bool = True, force: bool = False):
        """
        Publica os 4 tópicos do CP. Se ONLY_IF_CHANGED=True,
        só publica se mudou, exceto quando force=True.
        """
        base = topic_base(cp)

        payloads = {
            f"{base}_pressao": pressao,
            f"{base}_sp":      sp,
            f"{base}_adm":     adm,
            f"{base}_by":      by,
        }

        if ONLY_IF_CHANGED and not force:
            last = self._last_values.get(cp, {})
            changed = False
            for k, v in payloads.items():
                if last.get(k) != v:
                    changed = True
                    break
            if not changed:
                return  # nada mudou; não publica

        # publica efetivamente
        for t, v in payloads.items():
            # QoS 1 + retain garante que o Node-RED recebe após deploy
            self.cli.publish(t, v, qos=1, retain=retain)
        self._last_values[cp] = payloads

    def publish_all(self, retain: bool = True, reason: str = ""):
        """Lê e publica todos os CPs."""
        if reason:
            print(f"[PUB] publish_all (motivo: {reason})")

        for cp in CP_IDS:
            p, sp, adm, by = read_values(cp)
            self.publish_cp(cp, p, sp, adm, by, retain=retain, force=True)
        self._last_full = time.time()

    def loop(self):
        """
        Loop principal: publica continuamente e força um full publish
        periódico (proteção), evitando que pare após deploy/reconexão.
        """
        self.cli.connect(BROKER, PORT, keepalive=KEEPALIVE)
        self.cli.loop_start()

        try:
            while self._running:
                now = time.time()

                # proteção: a cada FULL_REPUBLISH_EVERY_S força republish completo
                if now - self._last_full >= FULL_REPUBLISH_EVERY_S:
                    self.publish_all(retain=True, reason="republish_periodico")

                # publicação contínua (todos os CPs)
                for cp in CP_IDS:
                    p, sp, adm, by = read_values(cp)
                    self.publish_cp(cp, p, sp, adm, by, retain=True)

                time.sleep(PUBLISH_INTERVAL_S)
        except KeyboardInterrupt:
            pass
        finally:
            # status offline
            try:
                self.cli.publish(STATUS_TOPIC, "offline", qos=1, retain=True)
            except Exception:
                pass
            self.cli.loop_stop()
            self.cli.disconnect()

    def stop(self):
        self._running = False


def main():
    pub = CPPublisher()

    def handle_sig(sig, frame):
        print("\n[SYS] encerrando…")
        pub.stop()

    signal.signal(signal.SIGINT, handle_sig)
    signal.signal(signal.SIGTERM, handle_sig)

    pub.loop()


if __name__ == "__main__":
    main()






[
    {
        "id": "tab-cps7",
        "type": "tab",
        "label": "Compressores (7 saidas)",
        "disabled": false,
        "info": ""
    },
    {
        "id": "in-mqtt-7",
        "type": "mqtt in",
        "z": "tab-cps7",
        "name": "CP vars",
        "topic": "factory/vars/clp_1500_cp/#",
        "qos": "1",
        "datatype": "utf8",
        "broker": "043114b042ce4fc3",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 470,
        "y": 320,
        "wires": [
            [
                "fn-demux-7",
                "f954d1f29468b1fb"
            ]
        ]
    },
    {
        "id": "tick-7",
        "type": "inject",
        "z": "tab-cps7",
        "name": "tick (1s) → força emissão",
        "props": [
            {
                "p": "tick",
                "v": "true",
                "vt": "bool"
            }
        ],
        "repeat": "1",
        "crontab": "",
        "once": false,
        "onceDelay": "0.5",
        "topic": "",
        "x": 480,
        "y": 260,
        "wires": [
            [
                "fn-demux-7"
            ]
        ]
    },
    {
        "id": "fn-demux-7",
        "type": "function",
        "z": "tab-cps7",
        "name": "Demux + cache (7 saídas)",
        "func": "/******************************************************\n * Demux + cache (7 saídas)\n * Entradas: MQTT em factory/vars/clp_1500_cp/cpXX_(pressao|sp|adm|by)\n *           e também qualquer \"tick\" para forçar emissão.\n * Saídas (1..7) = cp01..cp07 (array de arrays!)\n ******************************************************/\nvar IDS = ['cp01','cp02','cp03','cp04','cp05','cp06','cp07'];\nvar T_STALE = 10000; // 10s\n\n// cache\nvar cache = context.get('cp');\nif (!cache) {\n  cache = {};\n  IDS.forEach(function(id){\n    cache[id] = { id:id, pressao:null, sp:null, adm:null, by:null, ts:0 };\n  });\n}\n\n// atualiza cache se veio MQTT\nif (msg.topic && msg.topic.indexOf('factory/vars/clp_1500_cp/') === 0) {\n  var m = /clp_1500_cp\\/(cp\\d{2})_(pressao|sp|adm|by)$/.exec(msg.topic);\n  if (m) {\n    var id  = m[1];\n    var key = m[2];\n    var val = Number(msg.payload);\n    if (!isNaN(val)) {\n      cache[id][key] = val;\n      cache[id].ts = Date.now();\n    }\n    node.status({fill:'green',shape:'dot',text:'upd '+id+'.'+key+'='+String(msg.payload)});\n  } else {\n    node.status({fill:'red',shape:'ring',text:'ignorado: '+msg.topic});\n  }\n  context.set('cp', cache);\n}\n\n// monta array de ARRAYS: 1 subarray por saída\nvar now = Date.now();\nvar outs = [null,null,null,null,null,null,null];\nIDS.forEach(function(id, idx){\n  var d = cache[id];\n  var stale = !(d.ts && (now - d.ts) <= T_STALE);\n  outs[idx] = [{\n    topic: 'cp/' + id,\n    payload: { id:d.id, pressao:d.pressao, sp:d.sp, adm:d.adm, by:d.by, ts:d.ts, stale:stale }\n  }];\n});\nreturn outs;   // <- IMPORTANTE: array de arrays\n",
        "outputs": 7,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 320,
        "wires": [
            [
                "ui-cp01"
            ],
            [
                "ui-cp02"
            ],
            [
                "ui-cp03"
            ],
            [
                "ui-cp04"
            ],
            [
                "ui-cp05"
            ],
            [
                "ui-cp06"
            ],
            [
                "ui-cp07"
            ]
        ]
    },
    {
        "id": "ui-cp01",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP01",
        "order": 1,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp02",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP02",
        "order": 2,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp03",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP03",
        "order": 3,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp04",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP04",
        "order": 4,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 360,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp05",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP05",
        "order": 5,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp06",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP06",
        "order": 6,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "ui-cp07",
        "type": "ui_template",
        "z": "tab-cps7",
        "group": "ui-group-7",
        "name": "CP07",
        "order": 7,
        "width": 0,
        "height": 0,
        "format": "<!-- Card vertical – ocupa 100% do widget (sem vazio à direita) -->\n<style>\n    .nr-dashboard-template,\n    .cp-wrap,\n    .cp-card {\n        overflow: hidden !important;\n    }\n\n    /* preenche toda a largura do widget (sem centralizar com gap) */\n    .cp-wrap {\n        display: block;\n        padding: 6px 0;\n    }\n\n    .cp-card {\n        width: 100%;\n        max-width: none;\n        /* <- sem limite, ocupa 100% */\n        background: #161b22;\n        color: #e6edf3;\n        border: 1px solid #232a34;\n        border-radius: 14px;\n        padding: 12px;\n        box-sizing: border-box;\n    }\n\n    .cp-hd {\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        margin-bottom: 8px;\n    }\n\n    .cp-title {\n        font-weight: 700;\n        letter-spacing: .4px;\n    }\n\n    .cp-dot {\n        width: 10px;\n        height: 10px;\n        border-radius: 50%;\n        display: inline-block;\n        margin-right: 6px;\n        background: #555;\n    }\n\n    .cp-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n    }\n\n    .cell {\n        background: #0f1216;\n        border: 1px solid #232a34;\n        border-radius: 10px;\n        padding: 10px;\n    }\n\n    .lab {\n        color: #9aa4ad;\n        font-size: 12px;\n    }\n\n    .val {\n        font-size: 20px;\n        font-weight: 700;\n        line-height: 1.1;\n    }\n\n    .unit {\n        font-size: 12px;\n        color: #9aa4ad;\n        margin-left: 6px;\n    }\n</style>\n\n<div class=\"cp-wrap\">\n    <div class=\"cp-card\">\n        <div class=\"cp-hd\">\n            <div class=\"cp-title\">\n                <span class=\"cp-dot\"\n          ng-style=\"{'background': (msg.payload.stale ? '#6b7280'\n               : (msg.payload.pressao<7 ? '#ef4444'\n               : (msg.payload.pressao<7.5 ? '#f59e0b' : '#22c55e')))}\"></span>\n                {{ msg.payload.id | uppercase }}\n            </div>\n            <div class=\"cp-ts\">{{ msg.payload.ts | date:'HH:mm:ss' }}</div>\n        </div>\n\n        <div class=\"cp-grid\">\n            <div class=\"cell\">\n                <div class=\"lab\">Pressão</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.pressao === 0 || msg.payload.pressao !== undefined)\n               ? (msg.payload.pressao | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Setpoint</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.sp === 0 || msg.payload.sp !== undefined)\n               ? (msg.payload.sp | number:2) : '—' }}\n          </span><span class=\"unit\">bar</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Adm.</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.adm === 0 || msg.payload.adm !== undefined)\n               ? (msg.payload.adm | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n\n            <div class=\"cell\">\n                <div class=\"lab\">Bypass</div>\n                <div>\n                    <span class=\"val\">\n            {{ (msg.payload.by === 0 || msg.payload.by !== undefined)\n               ? (msg.payload.by | number:0) : '—' }}\n          </span><span class=\"unit\">%</span>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": false,
        "templateScope": "local",
        "className": "",
        "x": 1070,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "f954d1f29468b1fb",
        "type": "debug",
        "z": "tab-cps7",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 820,
        "y": 200,
        "wires": []
    },
    {
        "id": "043114b042ce4fc3",
        "type": "mqtt-broker",
        "name": "",
        "broker": "172.29.138.138",
        "port": 1883,
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": 4,
        "keepalive": 60,
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": "false",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closeRetain": "false",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willRetain": "false",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "ui-group-7",
        "type": "ui_group",
        "name": "Compressores",
        "tab": "ui-tab-7",
        "order": 1,
        "disp": true,
        "width": 7,
        "collapse": false
    },
    {
        "id": "ui-tab-7",
        "type": "ui_tab",
        "name": "Industriais",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "a276532bc65c86ad",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-dashboard": "3.6.6"
        }
    }
]
